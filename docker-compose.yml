
services:
  # R-Share Relay Server

  rshare-server:
    image: r-share/relay-server:latest
    build:
      context: ./server
      dockerfile: Dockerfile
      args:
        HTTP_PORT: ${HTTP_PORT:-8080}
        SOCKET_PORT: ${SOCKET_PORT:-10000}
    
  # container_name: rshare-server # removed to allow multiple instances via separate compose projects
    
    # Restart policy for production
    restart: unless-stopped
    
    # Port mappings
    ports:
      - "${HTTP_PORT:-8080}:${HTTP_PORT:-8080}"   # HTTP API
      - "${SOCKET_PORT:-10000}:${SOCKET_PORT:-10000}" # Socket server
    
    # Environment variables
    environment:
      # Spring Boot profile
      - SPRING_PROFILES_ACTIVE=default
      
      # Server configuration
      - SERVER_PORT=${HTTP_PORT:-8080}
      - SERVER_SOCKET_PORT=${SOCKET_PORT:-10000}

      # For compatibility with Dockerfile vars
      - HTTP_PORT=${HTTP_PORT:-8080}
      - SOCKET_PORT=${SOCKET_PORT:-10000}
      
      # JVM options - pass server ports as system properties so Spring can resolve them
      - JAVA_OPTS=-Xmx768m -Xms256m -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Dserver.port=${HTTP_PORT:-8080} -Dserver.socket.port=${SOCKET_PORT:-10000}
      
      # Logging
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_COM_SCAR=INFO
    
    # Volume mounts for persistent data
    volumes:
      # Application logs
      - ./logs:/app/logs
    
    # Health check
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${HTTP_PORT:-8080}/actuator/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1024M
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Network configuration
    networks:
      - rshare-network
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"


# Networks

networks:
  rshare-network:
    driver: bridge
    # Let Docker pick a free subnet per project; fixed subnets cause conflicts when running multiple compose projects


# Volumes

volumes:
  logs:
    driver: local

# USAGE INSTRUCTIONS
#
# Start the server:
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f rshare-server
#
# Stop the server:
#   docker-compose down
#
# Rebuild and restart:
#   docker-compose up -d --build
#
# Check health status:
#   docker-compose ps
#   curl http://localhost:${HTTP_PORT}/actuator/health
#
# View resource usage:
#   docker stats rshare-server
#
# ═══════════════════════════════════════════════════════════════════════════
